---
title: "Leaflet + Flexdashboard + DT + Crosstalk"
author: "Matt Dray"
output:
  flexdashboard::flex_dashboard:
    theme: paper
---

```{r setup, include=FALSE}
# prep workspace
library(dplyr)  # tidy data manipulation
library(leaflet)  # interative mapping
library(DT)  # interactive tables
library(crosstalk)  # inter-widget interactivity
sch <- readRDS("data/gias_sample.RDS")
sd <- SharedData$new(sch)
```

Interactives
=====================================  

Column {data-width=400}
-------------------------------------

### About

#### Filters

You can select multiple groups, devices and countries.

```{r filters}

filter_select(
  id = "geo_la",
  label = "Local authority",
  sharedData = sd,
  group = ~geo_la
)
filter_checkbox(
  id = "sch_phase",
  label = "Phase",
  sharedData = sd,
  group = ~sch_phase
)
filter_checkbox(
  id = "ofsted_rating",
  label = "Ofsted grade",
  sharedData = sd,
  group = ~ofsted_rating
)
filter_slider(
  id = "pup_count",
  label = "Pupil count",
  sharedData = sd,
  column = ~pup_count,
  step = 10,
  round = TRUE,
  sep = "",
  ticks = FALSE
)
```

### Datatable
    
```{r datatable}
DT::datatable(
  sd,
  filter = "top",  # allows filtering on each column
  extensions = c(
    "Buttons",  # add download buttons, etc
    "Scroller"  # for scrolling down the rows rather than pagination
  ),
  rownames = FALSE,  # remove rownames
  # style = "bootstrap",
  class = "compact",
  width = "100%",
  options = list(
    dom = "Blrtip",  # specify content (search box, etc)
    deferRender = TRUE,
    scrollY = 300,
    scroller = TRUE,
    columnDefs = list(
      list(
        visible = FALSE,
        targets = c(2, 3, 5:15)
      )
    ), 
    buttons = list(
      I("colvis"),  # turn columns on and off
      "csv",  # download as .csv
      "excel"  # download as .xlsx
    )
  )
)
```

Column {data-width=600}
-------------------------------------
    
### Interactive map
    
```{r map}
sd %>% 
  leaflet::leaflet() %>%
  leaflet::addProviderTiles(providers$OpenStreetMap) %>% 
  leaflet::addAwesomeMarkers(
    popup = ~paste0(
      "<h5>", sch$sch_name, "</h5>",
      
      "<table style='width:100%'>",
      
      "<tr>",
      "<th>URN</th>",
      "<th>", sch$sch_urn, "</th>",
      "</tr>",
      
      "<tr>",
      "<tr>",
      "<th>Phase</th>",
      "<th>", sch$sch_phase, "</th>",
      "</tr>",
      
      "<tr>",
      "<tr>",
      "<th>Type</th>",
      "<th>", sch$sch_type, "</th>",
      "</tr>",
      
      "<tr>",
      "<tr>",
      "<th>Location</th>",
      "<th>", sch$geo_town, ", ", sch$geo_postcode, "</th>",
      "</tr>",
      
      "<tr>",
      "<tr>",
      "<th>LA</th>",
      "<th>", sch$geo_la, "</th>",
      "</tr>"
    ),  # end popup()
    

    icon = awesomeIcons(
      
      library = "fa",

      icon = ifelse(
        test = sch$ofsted_rating == "Outstanding",
        yes = "fa-star",
        no = "fa-circle"
      ),

      iconColor = "white",
      
      markerColor = ifelse(
        test = sch$sch_phase == "Primary", 
        yes = "red",
        no = "blue"
      )
    )
    
  )  # end addAwesomeMarkers()
```

Information {data-orientation=rows}
===================================== 

### Blurb

<b>Crosstalk: Shiny-like without Shiny</b>

Self-service interactive tools have great power to support decisions by policy-makers. Shiny apps are a natural fit for this, but it's not always easy to share them within the public sector. This is due to issues like a lack of server space, highly sensitive data and users who aren't R-savvy.

We've approached this problem in the UK's Department for Education by sharing interactive HTML widgets – embeddable JavaScript visualisation libraries – within RMarkdown outputs. Interactivity is, however, limited because selections in one widget don’t impact the data presented in another.

[Joe Cheng's Crosstalk package](http://rstudio.github.io/crosstalk/) overcomes this with shared data objects that react to user inputs, altering the content of multiple widgets on the fly. I'll explain how I used Crosstalk to develop a 'pseudo-app' for exploring schools data with the Leaflet (maps), Plotly (charts) and DT (tables) widgets inside the Flexdashboard framework and how I shared it easily with policy-making users as a static HTML file for exploration in the browser.

### How to use

* Filter the data (options above) and the map and table will auto-update
* You can also select points using the movable/resizeable selection tool (click the broken rectangle button in the upper left of the map)
* You can also click rows of the datatable to highlight those points
* Zoom with the + and - buttons on the map (upper left), or with your mouse wheel
* Click markers to get information about that point

### Tools and thanks



* Mapping ([leaflet](https://rstudio.github.io/leaflet/)) geolocation ([freegeoip](https://github.com/luiscape/freegeoip)) of artificially-generated IP addresses ([generator](https://github.com/paulhendricks/generator)) with arbitrarily-assigned colours and icons ([ionicons](http://ionicons.com/))
* Wrapping this into a user-friendly interface ([flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/)) and including a table ([DT](https://rstudio.github.io/DT/))
* Allowing data selections to impact across both the map and table ([crosstalk](https://rstudio.github.io/crosstalk/))